to-do deployment


PROJECT_ID="fluted-factor-438905-d2"
SERVICE_ACCOUNT="todo-deployer@$PROJECT_ID.iam.gserviceaccount.com"

gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$SERVICE_ACCOUNT" --role="roles/container.admin"

gcloud iam service-accounts keys create key.json --iam-account=todo-deployer@fluted-factor-438905-d2.iam.gserviceaccount.com --project=fluted-factor-438905-d2

gcloud artifacts repositories create todo-repo --repository-format=docker --location=asia-south1 --description="ToDo App Docker Images"

gcloud container clusters create todo-cluster --zone asia-south1-a --num-nodes 3 --project fluted-factor-438905-d2

gcloud container clusters get-credentials todo-cluster --zone asia-south1-a --project fluted-factor-438905-d2


kubectl create secret generic mysql-secret --from-literal=mysql-root-password=root


gcloud projects add-iam-policy-binding fluted-factor-438905-d2 --member="serviceAccount:todo-deployer@fluted-factor-438905-d2.iam.gserviceaccount.com" --role="roles/artifactregistry.writer"

kubectl rollout restart deployment backend

curl -X POST http://34.100.187.174:5000/tasks -H "Content-Type: application/json" -d '{"title": "Test Task"}'


creating table

kubectl exec -it statefulset/mysql -- mysql -u root -p todo_db

pass: myStrongPassword123

SHOW DATABASES;
USE todo;
SHOW TABLES;

CREATE DATABASE IF NOT EXISTS todo_db;
USE todo_db;

CREATE TABLE IF NOT EXISTS tasks (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(255) NOT NULL
);


SHOW TABLES;
SELECT * FROM todo_db;

exit;

verify

# Check pods
kubectl get pods

# Check MySQL tables
kubectl exec -it statefulset/mysql -- mysql -u root -p -e "USE todo_db; SHOW TABLES;"

# Test backend directly
curl http://34.14.161.147:5000/tasks

firewall rule
gcloud compute firewall-rules create allow-backend-5000 --allow tcp:5000 --target-tags=gke-todo-cluster --description="Allow external access to backend on port 5000" --direction=INGRESS --source-ranges=0.0.0.0/0 --project=fluted-factor-438905-d2

kubectl create secret generic mysql-secret --from-literal=mysql-root-password=root

kubectl create configmap backend-config --from-literal=DB_HOST=mysql-service --from-literal=DB_USER=root --from-literal=DB_NAME=todo --from-literal=DB_PORT=3306 --from-literal=PORT=3000 --from-literal=ALLOWED_ORIGIN=*

helm upgrade --install todo-app ./helm --set frontend.service.loadBalancerIP=34.100.154.97 --set backend.service.loadBalancerIP=34.14.153.17 --set backend.image=asia-south1-docker.pkg.dev/fluted-factor-438905-d2/todo-repo/backend:latest --set frontend.image=asia-south1-docker.pkg.dev/fluted-factor-438905-d2/todo-repo/frontend:latest --set mysql.rootPassword=myStrongPassword123

kubectl delete svc todo-app-frontend-service todo-app-backend-service

gcloud container node-pools describe todo-nodes --cluster=todo-cluster --zone=asia-south1-a --format="value(config.serviceAccount)"

kubectl create configmap backend-config --from-literal=DB_HOST=todo-app-mysql-service --from-literal=DB_USER=root --from-literal=DB_NAME=todo --from-literal=DB_PORT=3306 --from-literal=PORT=3000 --from-literal=ALLOWED_ORIGIN="*"



# Authenticate with GAR
gcloud auth configure-docker asia-south1-docker.pkg.dev

# Build and push backend
docker build -t asia-south1-docker.pkg.dev/fluted-factor-438905-d2/todo-repo/backend:latest ./backend
docker push asia-south1-docker.pkg.dev/fluted-factor-438905-d2/todo-repo/backend:latest

# Build and push frontend
docker build -t asia-south1-docker.pkg.dev/fluted-factor-438905-d2/todo-repo/frontend:latest ./frontend
docker push asia-south1-docker.pkg.dev/fluted-factor-438905-d2/todo-repo/frontend:latest

 kubectl create secret generic mysql-secret --from-literal=mysql-root-password=myStrongPassword123 --from-literal=mysql-user=todo_user --from-literal=mysql-password=todo_pass

 gcloud artifacts docker images list asia-south1-docker.pkg.dev/fluted-factor-438905-d2/todo-repo/backend --include-tags


kubectl get pods -o wide

kubectl get svc    

....

terraform import google_container_node_pool.todo_nodes "projects/${var.project_id}/locations/${var.zone}/clusters/todo-cluster/nodePools/todo-nodes"


gcloud projects add-iam-policy-binding fluted-factor-438905-d2 --member="serviceAccount:todo-deployer@fluted-factor-438905-d2.iam.gserviceaccount.com" --role="roles/resourcemanager.projectIamAdmin"

gcloud projects add-iam-policy-binding fluted-factor-438905-d2 --member="serviceAccount:todo-deployer@fluted-factor-438905-d2.iam.gserviceaccount.com" --role="roles/container.admin"

gcloud projects add-iam-policy-binding fluted-factor-438905-d2 --member="serviceAccount:todo-deployer@fluted-factor-438905-d2.iam.gserviceaccount.com" --role="roles/compute.admin"

terraform import google_container_node_pool.todo_nodes "projects/fluted-factor-438905-d2/locations/asia-south1-a/clusters/todo-cluster/nodePools/todo-nodes"

ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiZmx1dGVkLWZhY3Rvci00Mzg5MDUtZDIiLAogICJwcml2YXRlX2tleV9pZCI6ICI1MTQzNmYxMTcwMWRkMzg3OTdkNzBhMDA0MGUwYzRmNDlhYTFkMGM4IiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdmdJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLZ3dnZ1NrQWdFQUFvSUJBUURxcUM1b0NCOUR1dG8vXG42MjBxanpSZ1F4WUlIK25rL2sydXlNU1JWNlA0RTJvdlRmajcrVHV1WGkwcDJ2NHM0VytLKzFPWWVDeW9NMTZtXG4wTlFtOWxZdHdPOHVZZEVOTklCV2ZWMUprd3RaOXZpSHlkYktGV3ZhNXI4c2xlMXE0ekNVVTV2ZkFJTVhUVnIzXG5OK0JtYi85b2YxMlZrb2NsSUdsVUEvY3hHU1BSaS9FeHJSSTRBYko0NDdqTVZvUzVhTEc2TWJYbEdxUEh2R3ROXG45OVVWMjBnT0pFZGxaU3VrUUU0dmdQM3luMEJQNXdyRkhQZkhBVGdjVjMzeVljVGtUU1N3eGJkck1ZRFRYYjJsXG5ZMnFlZnBLcWFJN29CUjFTMU1qd2tWQU9VeUpCWVVwZ3pBN1pOV2RRYnNXWnhZdkZQQk5rY0RUV0txK1ZrdWxjXG5sY3ZRMDFLTkFnTUJBQUVDZ2dFQVN4Ryt0dDFTVXpLbHU2a3ZaVndtMzF6VzRZYUVKeFFMK2d5VWhnTEpuQVZxXG5CUFFtNFVWY2lHM3NlT1ZzUnlOZnNkQ3hiNmVTY2NUdFZPU2QybEVZUk03aU5hNXBXSlloTUlvdW0ra0V5cVV0XG40Ukw3T2U4Y2NBMDl2NSsvTW1DNEc5dWJrLzN2OGpaM0VYdTR1RXpBSXNnTVFsdDhESzZQdzZiNUg2WHhSWW1vXG5tdWt1Vmp0OGlFQ2FUYm9uQnRXT2JjUldXSm84azczbjIrcUtwM1BLRktVRlE1akYxZVlid1JJWWxXTXVnZnhwXG5NelZGQjVaMjZFeERYL2t0ZFl5bFNpc2NtZUV4anF1czBJclo5SVEzMVJPd2ZTSTBRaGNlbWNZemhvN0NDZ3VrXG5Jc1kyKzZYRDZLeFdGdjFBVU54Z2hBQmRKc0R3eUVSbE00U0pTWmJEYVFLQmdRRDlIMWkvRW9xbEFzL25URWVkXG5BSzZiZ08wN0x2ZDBRYnM4cW4rVno0QjdJOElDdS9MQkJlWWRXaHZYSWxjWE9HWm9vQWwvV0dXSjBMMzZETEhzXG5mYVlBNVBEeEhMMThQclFmbGJGZkJOOHVKWFNXalFaN2RPa0E5ZDNLK3FNeWZSeEZrdXBVblB6NnhVTkx6OGdmXG5RLzhpQU45Y2lvemFYMDBBMmJkR05waXp1d0tCZ1FEdFV4aGJkTnUwV3FPc05NT29DNXBaWTJoc3g4TU5YQVVZXG5Ka0xPNUUwT3N2WFhwQ3Z5Sk9LdVhXdEpEclFac1ZEZ2VIZGZLN29CU285SmV3THVSZHJhS0pORS9PUXA1Wm40XG5YWm5XcWdmMCthUFR6L1haTFBwTmpHaVU5eUxnWlhraFA4QU4rWXNYd0JZR2RaT0xpcnFxenlDWUlRenRaZUR2XG5ubDZ4K1JQYVZ3S0JnUURaVktiUU44MU83T0V4U1M5YndKQXErRUc0UlJVMmZwR1MveGxZdWJjcEE0UzY4RUQ0XG5ObVpqNFZCeUlRd0I1ZTBYL0FEcmxDeHFiZzRQdWdLeWVSZWxRTzBYT0lRQlA1MU1XU3pYMXNrQlNDdVljREdXXG5vc1RFakZZSXg3YUR6U1FQSUp1T1Z0Um5SQ1FKM2JlSUVNdm9tRE12czg1SVdQYzJ1YmhBMHZPOXJRS0JnRGpDXG5XTjcyc2QwT21IcUZIQTVDeUNWOHl1ckpVL01NQVFQbmtxN2NsemxldjhGVk9GVnZVTytXMUNQaTZsd0N0bThaXG5JS09ZVjZJYmJPMk1DQVZvbTVEMWgxTkdrR01jMEpnLytwMEdpV1NqbC9UK2xiUGROL2Y0RHNNaDRDdCsyVnVFXG5YYkI1OERRNzhvaVU4amE3ZFMySTRDakNMczlRUUYzT3FLTTBDUFY5QW9HQkFMZEZKZVlCb2hXVnExNEhkc2lmXG4vaGRqOEcrVnhxeGdBNUZDOUVHQ0xqcjIvTlpmcFBBWStCWFV0bFFNcnNHaDhKbEY2cmtjci8rdUhWa2xsUHA4XG56WldlclRqR3dWSS9HUWg4NmNqUC8ra0JkbkprSUlxdTVOa0R0SUZkbStYRlFneEZCMDB6WUMyYjY2T3FpK2N2XG4yNHY2VjJPc3dNTC82ejl3UldiTmtTTnJcbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJ0b2RvLWRlcGxveWVyQGZsdXRlZC1mYWN0b3ItNDM4OTA1LWQyLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExNDQ5NTQyMjkyNDIzODA3NjIwNCIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvdG9kby1kZXBsb3llciU0MGZsdXRlZC1mYWN0b3ItNDM4OTA1LWQyLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAidW5pdmVyc2VfZG9tYWluIjogImdvb2dsZWFwaXMuY29tIgp9Cg== 